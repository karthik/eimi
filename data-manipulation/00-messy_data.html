<h1>A short tutorial on how to read and clean messy data</h1>

<p>Raw data from various ecological studies can be poorly formatted and/or may lack appropriate details of the study. Correcting data in place can be a dangerous exercise since the original raw data would get overwritten and there would be no way to audit this process or recover from mistakes made during this time. A good data practice would be to maintain the original data, but use a programmatic script to clean it, fix mistakes and save that cleaned dataset for further analysis. </p>

<p><img src="sample_workflow.png" alt="A sample workflow"/></p>

<h2>Tidy data</h2>

<ul>
<li>Tidy data vs Clean data</li>
</ul>

<h3>Most common problems:</h3>

<ol>
<li>Values as columns  (melt to long format)</li>
<li>Multiple values in a single cell (some regexpr to split em)</li>
<li>Variables in rows (cast)</li>
</ol>

<h3>A warm-up example</h3>

<pre><code class="r">dat &lt;- data.frame(males = c(injured = 4, uninjured = 2), females = c(injured = 1, uninjured = 5))
dat
</code></pre>

<pre><code>##           males females
## injured       4       1
## uninjured     2       5
</code></pre>

<p>Rowames as a column we can manipulate</p>

<pre><code class="r">dat &lt;- cbind(dat, status = rownames(dat)) 
dat
</code></pre>

<pre><code>##           males females    status
## injured       4       1   injured
## uninjured     2       5 uninjured
</code></pre>

<p>Get values out of columns, variables as columns:</p>

<pre><code class="r">library(&quot;reshape2&quot;)
dat &lt;- melt(dat, &quot;status&quot;) 
</code></pre>

<p>Add some nice metadata that was absent before:</p>

<pre><code class="r">names(dat) &lt;- c(&quot;status&quot;, &quot;sex&quot;, &quot;count&quot;)
dat
</code></pre>

<pre><code>##      status     sex count
## 1   injured   males     4
## 2 uninjured   males     2
## 3   injured females     1
## 4 uninjured females     5
</code></pre>

<hr/>

<h2>More messy: non-standard input formats</h2>

<p>In the example below, we use a data file obtained as plain text and clean up incorrect spacing and separators. Then we look up the appropriate metadata </p>

<pre><code class="r">library(&quot;stringr&quot;)
# If you don&#39;t have this package simply run install.packages(&quot;stringr&quot;)
rawData &lt;- readLines(&quot;data/messy_data.txt&quot;)
rawData
</code></pre>

<pre><code>## [1] &quot;J. Pritchard    01/12 - 12/11  1 1500 W  7.0 420 48  Migratory 3&quot;
## [2] &quot;E. Jones  02/18 - 04/21  4 1293 N  8.0 490 48  Resident 1&quot;       
## [3] &quot;J. Pritchard   01/13 - 02/17   15 1028 N  4.0 46  460 Migratory&quot; 
## [4] &quot;Matt Jones   09/23 - 11/23  23 563 N   3.0 470 47  Resident 2&quot;   
## [5] &quot;S. Chamberlain 07/05 - 09/26 22  713 N   5.2 500 45  Resident 4&quot; 
## [6] &quot;C. Boettiger 10/24 - 10/30   1495 S 30 1.9 47  410 Migratory&quot;
</code></pre>

<pre><code class="r"># Count number of lines (make sure it&#39;s what you&#39;re expecting)
length(rawData)
</code></pre>

<pre><code>## [1] 6
</code></pre>

<p>We&#39;ve got two issues here. First, we need to split the dates into two separate fields. Next we need to remove the uneven spaces and split the remaining data into individual cells. We can write functions to accomplish both tasks.</p>

<pre><code class="r"># First we use a function in the stringr package to locate where the dashes are.
# Note that we are not just searching for the dash but a string that includes the space before and after.
dashes &lt;- str_locate_all(rawData, &quot; - &quot;)
# Let&#39;s make sure it looks right
rawData[1]
</code></pre>

<pre><code>## [1] &quot;J. Pritchard    01/12 - 12/11  1 1500 W  7.0 420 48  Migratory 3&quot;
</code></pre>

<pre><code class="r">dashes[1]
</code></pre>

<pre><code>## [[1]]
##      start end
## [1,]    22  24
</code></pre>

<pre><code class="r"># -----------------------------------------------
# A function to remove extra spaces and split the dates
# -------------------------------------------
splitByDate &lt;- function(str, start, finish) {

    beginning &lt;- str_sub(str, 1, start - 6)
    dates &lt;- str_sub(str, start - 5, finish + 5)
    end &lt;- str_sub(str, finish + 6, str_length(str))

    beginning &lt;- str_trim(beginning)
    dates &lt;- str_split(dates, &quot; - &quot;)

    while(str_detect(end, &quot;  &quot;)) {
       end &lt;- str_replace_all(str_trim(end), &quot;  &quot;, &quot; &quot;)    
    }

    end &lt;- str_split(end, &quot; &quot;)
    return(c(unlist(beginning), unlist(dates), unlist(end)))
}

# A function to return a nicely formatted dataset
# -------------------------------------------
formatData  &lt;- function(rawD) {
    longest_row &lt;- max(sapply(rawD, length))
    # If any rows have missing data, we pad it with NAs so we get a clean data.frame
    results &lt;- sapply(rawD, function(y) {
        if(length(y) &lt; longest_row)
            c(y, rep(NA, longest_row - length(y))) 
        else 
            y
    })

    return(as.data.frame(t(results)))
} 
</code></pre>

<pre><code class="r">first_pass &lt;- sapply(1:length(rawData), function(x) {
    splitByDate(rawData[x], dashes[[x]][1], dashes[[x]][2])
})

cleaned_data &lt;- formatData(first_pass)
names(cleaned_data) &lt;- c(&quot;observer&quot;, &quot;date_first&quot;, &quot;date_last&quot;, &quot;id&quot;, &quot;distance&quot;, &quot;direction&quot;, &quot;speed&quot;, &quot;measurex&quot;, &quot;measurey&quot;, &quot;migratory_status&quot;, &quot;times_observed&quot;)
</code></pre>

<pre><code class="r"># str is short for structure
str(cleaned_data)
</code></pre>

<pre><code>## &#39;data.frame&#39;:    6 obs. of  11 variables:
##  $ observer        : chr  &quot;J. Pritchard&quot; &quot;E. Jones&quot; &quot;J. Pritchard&quot; &quot;Matt Jones&quot; ...
##  $ date_first      : chr  &quot;01/12&quot; &quot;02/18&quot; &quot;01/13&quot; &quot;09/23&quot; ...
##  $ date_last       : chr  &quot;12/11&quot; &quot;04/21&quot; &quot;02/17&quot; &quot;11/23&quot; ...
##  $ id              : chr  &quot;1&quot; &quot;4&quot; &quot;15&quot; &quot;23&quot; ...
##  $ distance        : chr  &quot;1500&quot; &quot;1293&quot; &quot;1028&quot; &quot;563&quot; ...
##  $ direction       : chr  &quot;W&quot; &quot;N&quot; &quot;N&quot; &quot;N&quot; ...
##  $ speed           : chr  &quot;7.0&quot; &quot;8.0&quot; &quot;4.0&quot; &quot;3.0&quot; ...
##  $ measurex        : chr  &quot;420&quot; &quot;490&quot; &quot;46&quot; &quot;470&quot; ...
##  $ measurey        : chr  &quot;48&quot; &quot;48&quot; &quot;460&quot; &quot;47&quot; ...
##  $ migratory_status: chr  &quot;Migratory&quot; &quot;Resident&quot; &quot;Migratory&quot; &quot;Resident&quot; ...
##  $ times_observed  : chr  &quot;3&quot; &quot;1&quot; NA &quot;2&quot; ...
</code></pre>

<pre><code class="r">cleaned_data$date_first
</code></pre>

<pre><code>## [1] &quot;01/12&quot; &quot;02/18&quot; &quot;01/13&quot; &quot;09/23&quot; &quot;07/05&quot; &quot;10/24&quot;
</code></pre>

<pre><code class="r"># oops, we forgot to add the year. All these data were collected in 2012
cleaned_data$date_first  &lt;- paste0(cleaned_data$date_first, &quot;/12&quot;)
cleaned_data$date_last  &lt;- paste0(cleaned_data$date_last, &quot;/12&quot;)

# Now let&#39;s typecast these data as a Date class
cleaned_data$date_first &lt;- as.Date(cleaned_data$date_first, &quot;%m/%d/%y&quot;)
cleaned_data$date_last &lt;- as.Date(cleaned_data$date_last, &quot;%m/%d/%y&quot;)
</code></pre>

<p>We can examine the data to make sure everything looks ok.</p>

<pre><code class="r">head(cleaned_data)
</code></pre>

<pre><code>##         observer date_first  date_last   id distance direction speed
## 1   J. Pritchard 2012-01-12 2012-12-11    1     1500         W   7.0
## 2       E. Jones 2012-02-18 2012-04-21    4     1293         N   8.0
## 3   J. Pritchard 2012-01-13 2012-02-17   15     1028         N   4.0
## 4     Matt Jones 2012-09-23 2012-11-23   23      563         N   3.0
## 5 S. Chamberlain 2012-07-05 2012-09-26   22      713         N   5.2
## 6   C. Boettiger 2012-10-24 2012-10-30 1495        S        30   1.9
##   measurex measurey migratory_status times_observed
## 1      420       48        Migratory              3
## 2      490       48         Resident              1
## 3       46      460        Migratory           &lt;NA&gt;
## 4      470       47         Resident              2
## 5      500       45         Resident              4
## 6       47      410        Migratory           &lt;NA&gt;
</code></pre>

<pre><code class="r">tail(cleaned_data)
</code></pre>

<pre><code>##         observer date_first  date_last   id distance direction speed
## 1   J. Pritchard 2012-01-12 2012-12-11    1     1500         W   7.0
## 2       E. Jones 2012-02-18 2012-04-21    4     1293         N   8.0
## 3   J. Pritchard 2012-01-13 2012-02-17   15     1028         N   4.0
## 4     Matt Jones 2012-09-23 2012-11-23   23      563         N   3.0
## 5 S. Chamberlain 2012-07-05 2012-09-26   22      713         N   5.2
## 6   C. Boettiger 2012-10-24 2012-10-30 1495        S        30   1.9
##   measurex measurey migratory_status times_observed
## 1      420       48        Migratory              3
## 2      490       48         Resident              1
## 3       46      460        Migratory           &lt;NA&gt;
## 4      470       47         Resident              2
## 5      500       45         Resident              4
## 6       47      410        Migratory           &lt;NA&gt;
</code></pre>

<p>Now we can confidently save these data into a separate file which we called <code>cleaned_data.csv</code>. In a real world use case your file name would be more descriptive.</p>

<pre><code class="r">write.csv(cleaned_data, file = &quot;data/cleaned_data.csv&quot;)
</code></pre>

<p>As you can see in the <code>data</code> folder, we now have both the original untransformed raw data and also the cleaned data which is now read for further analysis. If there&#39;s ever any questions about the cleanup process, this script will provide a way to audit all the steps. The original data are always there untouched. Now you are free to proceed with the analysis and the reporting.</p>
